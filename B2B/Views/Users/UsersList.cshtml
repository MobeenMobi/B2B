@model IEnumerable<B2B.ViewModels.UserCompanyDetailsViewModel>

@section PageContent {
    @if (TempData["ApproveMessage"] != null)
    {
        <div class="alert alert-success">
            @TempData["ApproveMessage"]
        </div>
    }

    @if (TempData["ReturnMessage"] != null)
    {
        <div class="alert alert-success">
            @TempData["ReturnMessage"]
        </div>
    }

    <table class="table table-bordered table-striped">
        <thead class="table-light">
            <tr>
                <th>Name (Person In Charge)</th>
                <th>Company Name</th>
                <th>Business Type</th>
                <th>KYB Approved?</th>
                <th>View Documents</th>
                <th>Actions</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var user in Model)
            {
                <tr>
                    <td>@user.FirstName @user.LastName</td>
                    <td>@user.CompanyName</td>
                    <td>@user.BusinessType</td>

                    <td class="text-center">
                        @(user.IsKYBApproved ? "✅ Yes" : "❌ No")
                    </td>

                    <td class="text-center">
                        <button class="btn btn-sm btn-primary"
                                onclick="viewDocuments(@user.UserId)">
                            View Documents
                        </button>
                    </td>

                    <td class="text-center">
                        @if (user.IsKYBApproved)
                        {
                            <a href="javascript:void(0)"
                               class="btn btn-sm btn-success disabled">
                                Approved
                            </a>
                        }
                        else
                        {
                            <a asp-controller="Users"
                               asp-action="UserEdit"
                               asp-route-id="@user.UserId"
                               class="btn btn-sm btn-primary">
                                Approve
                            </a>

                            <a href="#"
                               class="btn btn-sm btn-warning"
                               data-bs-toggle="modal"
                               data-bs-target="#returnModal"
                               data-user-id="@user.UserId">
                                Return
                            </a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- ================= DOCUMENT VIEW MODAL ================= -->
    <div class="modal fade" id="docsModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Uploaded Documents
                    </h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal">
                    </button>
                </div>

                <div class="modal-body">
                    <div id="documentsContainer"
                         class="row">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="returnModal" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Return User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <textarea class="form-control" id="returnComments" placeholder="Enter comments..." rows="4"></textarea>
                    <input type="hidden" id="hiddenUserId" />
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                    <button type="button" class="btn btn-primary" id="submitReturn">
                        Submit
                    </button>
                </div>

            </div>
        </div>
    </div>


}

@section Scripts {
    <!-- jQuery (Required for Ajax) -->


    <script>

             $(document).ready(function () {

            // When modal opens, capture the UserId
            $('#returnModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);   // Button that opened modal
                var userId = button.data('user-id');   // Get UserId attribute

                $('#hiddenUserId').val(userId);
            });

            // Handle Submit click
            $('#submitReturn').on('click', function () {

                var id = $('#hiddenUserId').val();
                var comments = $('#returnComments').val();

                if ($.trim(comments) === "") {
                    alert("Comments are required.");
                    return;
                }

                // Redirect to action
                window.location.href = `/Users/KYBReturn/${id}?comments=${encodeURIComponent(comments)}`;
            });

        });

        function viewDocuments(userId)
        {
            $("#documentsContainer").html(
                "<p class='text-center'>Loading documents...</p>"
            );

            $.ajax({
                url: "/Users/GetUserDocuments",   // Change if controller name is different
                type: "GET",
                data: { userId: userId },

                success: function (response)
                {
                    if (response.length === 0)
                    {
                        $("#documentsContainer").html(
                            "<p class='text-danger'>No documents uploaded by this user.</p>"
                        );

                        $("#docsModal").modal("show");
                        return;
                    }

                    let html = "";

                    response.forEach(function (doc)
                    {
                        let extension = doc.documentPath
                            .split('.')
                            .pop()
                            .toLowerCase();

                        // ---- PDF ----
                        if (extension === "pdf")
                        {
                            html += `
                            <div class="col-md-6 mb-4">
                                <h6>${doc.documentName}</h6>
                                <iframe
                                    src="${doc.documentPath}"
                                    width="100%"
                                    height="500px"
                                    class="border rounded">
                                </iframe>
                            </div>
                            `;
                        }

                        // ---- Images ----
                        else if (["jpg", "jpeg", "png", "webp"].includes(extension))
                        {
                            html += `
                            <div class="col-md-4 mb-4 text-center">
                                <h6>${doc.documentName}</h6>
                                <img src="${doc.documentPath}"
                                     class="img-fluid rounded border"
                                     style="max-height:350px;" />
                            </div>
                            `;
                        }

                        // ---- Other files (docx/xlsx/zip etc) ----
                        else
                        {
                            html += `
                            <div class="col-12 mb-3">
                                <h6>${doc.documentName}</h6>
                                <a class="btn btn-secondary"
                                   href="${doc.documentPath}"
                                   target="_blank">
                                   Download Document
                                </a>
                            </div>
                            `;
                        }
                    });

                    $("#documentsContainer").html(html);
                    $("#docsModal").modal("show");
                },

                error: function ()
                {
                    $("#documentsContainer").html(
                        "<p class='text-danger'>Error loading documents</p>"
                    );

                    $("#docsModal").modal("show");
                }
            });
        }

    </script>
}
